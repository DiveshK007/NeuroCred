name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true
        type: string

env:
  ENVIRONMENT: production
  K8S_NAMESPACE: neurocred-prod
  DOCKER_REGISTRY: ghcr.io
  DOCKER_IMAGE_NAME: ${{ github.repository_owner }}/neurocred

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.1.0"
      
      - name: Configure kubectl
        run: |
          echo "${{ secrets.K8S_CONFIG_PROD }}" | base64 -d > kubeconfig
          export KUBECONFIG=./kubeconfig
          kubectl config set-context --current --namespace=${{ env.K8S_NAMESPACE }}
      
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Update image tags
        run: |
          cd k8s/overlays/prod
          kustomize edit set image \
            backend=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/backend:${{ steps.version.outputs.version }} \
            frontend=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/frontend:${{ steps.version.outputs.version }} \
            worker-score=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/worker-score:${{ steps.version.outputs.version }} \
            worker-blockchain=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/worker-blockchain:${{ steps.version.outputs.version }}
      
      - name: Blue-green deployment
        run: |
          export KUBECONFIG=./kubeconfig
          ./scripts/blue-green-deploy.sh prod ${{ steps.version.outputs.version }}
      
      - name: Run smoke tests
        run: |
          export KUBECONFIG=./kubeconfig
          BACKEND_URL=$(kubectl get ingress -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.items[0].spec.rules[0].host}')
          curl -f https://${BACKEND_URL}/health || exit 1
          curl -f https://${BACKEND_URL}/health/ready || exit 1
      
      - name: Verify deployment
        run: |
          export KUBECONFIG=./kubeconfig
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}
          kubectl get services -n ${{ env.K8S_NAMESPACE }}
          kubectl get ingress -n ${{ env.K8S_NAMESPACE }}

