name: Deploy to Staging

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  ENVIRONMENT: staging
  K8S_NAMESPACE: neurocred-staging
  DOCKER_REGISTRY: ghcr.io
  DOCKER_IMAGE_NAME: ${{ github.repository_owner }}/neurocred

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.1.0"
      
      - name: Configure kubectl
        run: |
          echo "${{ secrets.K8S_CONFIG_STAGING }}" | base64 -d > kubeconfig
          export KUBECONFIG=./kubeconfig
          kubectl config set-context --current --namespace=${{ env.K8S_NAMESPACE }}
      
      - name: Update image tags
        run: |
          cd k8s/overlays/staging
          kustomize edit set image \
            backend=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/backend:staging-${{ github.sha }} \
            frontend=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/frontend:staging-${{ github.sha }} \
            worker-score=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/worker-score:staging-${{ github.sha }} \
            worker-blockchain=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/worker-blockchain:staging-${{ github.sha }}
      
      - name: Deploy to Kubernetes
        run: |
          export KUBECONFIG=./kubeconfig
          kubectl apply -k k8s/overlays/staging
          kubectl rollout status deployment/staging-backend -n ${{ env.K8S_NAMESPACE }} --timeout=10m
          kubectl rollout status deployment/staging-frontend -n ${{ env.K8S_NAMESPACE }} --timeout=10m
      
      - name: Run smoke tests
        run: |
          export KUBECONFIG=./kubeconfig
          BACKEND_URL=$(kubectl get ingress -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.items[0].spec.rules[0].host}')
          curl -f https://${BACKEND_URL}/health || exit 1
      
      - name: Verify deployment
        run: |
          export KUBECONFIG=./kubeconfig
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}
          kubectl get services -n ${{ env.K8S_NAMESPACE }}

