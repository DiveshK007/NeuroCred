name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      deployment:
        description: 'Deployment to rollback (leave empty for all)'
        required: false
        type: string
        default: ''
      revision:
        description: 'Revision number to rollback to (leave empty for previous)'
        required: false
        type: string
        default: ''

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig
          export KUBECONFIG=./kubeconfig
          kubectl config set-context --current --namespace=neurocred-${{ github.event.inputs.environment }}
      
      - name: Show rollout history
        run: |
          export KUBECONFIG=./kubeconfig
          DEPLOYMENT="${{ github.event.inputs.deployment }}"
          NAMESPACE="neurocred-${{ github.event.inputs.environment }}"
          
          if [ -z "$DEPLOYMENT" ]; then
            echo "Showing history for all deployments:"
            kubectl rollout history deployment/backend -n "$NAMESPACE" || true
            kubectl rollout history deployment/frontend -n "$NAMESPACE" || true
            kubectl rollout history deployment/worker -n "$NAMESPACE" || true
          else
            echo "Showing history for $DEPLOYMENT:"
            kubectl rollout history deployment/"$DEPLOYMENT" -n "$NAMESPACE"
          fi
      
      - name: Rollback deployment
        run: |
          export KUBECONFIG=./kubeconfig
          DEPLOYMENT="${{ github.event.inputs.deployment }}"
          REVISION="${{ github.event.inputs.revision }}"
          NAMESPACE="neurocred-${{ github.event.inputs.environment }}"
          
          if [ -z "$DEPLOYMENT" ]; then
            # Rollback all services
            for service in backend frontend worker; do
              echo "Rolling back $service..."
              if [ -z "$REVISION" ]; then
                kubectl rollout undo deployment/"$service" -n "$NAMESPACE"
              else
                kubectl rollout undo deployment/"$service" --to-revision="$REVISION" -n "$NAMESPACE"
              fi
            done
          else
            # Rollback specific deployment
            if [ -z "$REVISION" ]; then
              kubectl rollout undo deployment/"$DEPLOYMENT" -n "$NAMESPACE"
            else
              kubectl rollout undo deployment/"$DEPLOYMENT" --to-revision="$REVISION" -n "$NAMESPACE"
            fi
          fi
      
      - name: Wait for rollout
        run: |
          export KUBECONFIG=./kubeconfig
          DEPLOYMENT="${{ github.event.inputs.deployment }}"
          NAMESPACE="neurocred-${{ github.event.inputs.environment }}"
          
          if [ -z "$DEPLOYMENT" ]; then
            for service in backend frontend worker; do
              echo "Waiting for $service rollout..."
              kubectl rollout status deployment/"$service" -n "$NAMESPACE" --timeout=300s || true
            done
          else
            kubectl rollout status deployment/"$DEPLOYMENT" -n "$NAMESPACE" --timeout=300s
          fi
      
      - name: Verify health
        run: |
          export KUBECONFIG=./kubeconfig
          NAMESPACE="neurocred-${{ github.event.inputs.environment }}"
          
          # Wait a bit for services to stabilize
          sleep 10
          
          # Check backend health
          if [ "${{ github.event.inputs.environment }}" == "prod" ]; then
            API_URL="https://api.neurocred.io"
          else
            API_URL="https://api-${{ github.event.inputs.environment }}.neurocred.io"
          fi
          
          echo "Checking health at $API_URL/health"
          curl -f "$API_URL/health" || echo "Health check failed (may need more time)"
      
      - name: Show deployment status
        run: |
          export KUBECONFIG=./kubeconfig
          NAMESPACE="neurocred-${{ github.event.inputs.environment }}"
          
          echo "Deployment Status:"
          kubectl get deployments -n "$NAMESPACE"
          echo ""
          echo "Pod Status:"
          kubectl get pods -n "$NAMESPACE"
