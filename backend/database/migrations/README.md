# Database Migrations Guide

This guide explains how to manage database migrations for NeuroCred.

## Overview

We use Alembic for version-controlled database migrations. All schema changes should be done through migrations, never by directly modifying the database.

## Migration Workflow

### Creating a New Migration

1. **Modify Models**: Update models in `backend/database/models.py`

2. **Generate Migration**:
   ```bash
   cd backend
   alembic revision --autogenerate -m "description of changes"
   ```

3. **Review Migration**: Check the generated migration file in `backend/alembic/versions/`

4. **Test Migration**: Run the migration on a test database first

5. **Apply Migration**: Apply to target environment

### Running Migrations

**Local Development**:
```bash
cd backend
alembic upgrade head
```

**Staging/Production**:
```bash
# Set DATABASE_URL environment variable
export DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/dbname
alembic upgrade head
```

### Rolling Back Migrations

**Rollback One Version**:
```bash
alembic downgrade -1
```

**Rollback to Specific Version**:
```bash
alembic downgrade <revision_id>
```

**Rollback All**:
```bash
alembic downgrade base
```

## Migration Scripts

### `scripts/migrate.sh`

Automated migration script that:
- Validates environment
- Checks migration status
- Applies pending migrations
- Verifies migration success

Usage:
```bash
./scripts/migrate.sh [environment]
```

### `scripts/rollback-migration.sh`

Rollback script that:
- Validates rollback target
- Creates backup before rollback
- Executes rollback
- Verifies database state

Usage:
```bash
./scripts/rollback-migration.sh [revision_id]
```

## Migration Best Practices

1. **Always Review Autogenerated Migrations**: Alembic may not catch all changes
2. **Test Migrations**: Test on a copy of production data
3. **Backup Before Migration**: Always backup before applying migrations
4. **One Change Per Migration**: Keep migrations focused and atomic
5. **Document Breaking Changes**: Add notes for schema changes
6. **Test Rollback**: Ensure migrations can be rolled back safely

## Migration Naming Convention

- `001_initial_schema.py` - Initial database schema
- `002_expand_schema.py` - Schema expansion
- `003_add_retention_fields.py` - Add retention fields
- `004_add_indexes.py` - Performance improvements

## CI/CD Integration

Migrations are automatically tested in CI/CD:
- Migrations are validated on pull requests
- Migrations are applied automatically to staging
- Production migrations require manual approval

## Troubleshooting

### Migration Fails

1. Check database connection
2. Verify migration file syntax
3. Check for conflicting migrations
4. Review error logs
5. Rollback if necessary

### Migration Stuck

1. Check for locks on database
2. Verify migration status: `alembic current`
3. Check for pending transactions
4. Contact database administrator if needed

## Migration Status

Check current migration version:
```bash
alembic current
```

List all migrations:
```bash
alembic history
```

Show pending migrations:
```bash
alembic heads
```

